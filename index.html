<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIN Tracker</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            padding-bottom: 80px;
            margin: 0;
        }

        h1, h3 {
            text-align: center;
            margin: 10px 0;
        }

        /* Navigation */
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            background: white;
            border-top: 2px solid black;
        }

        .nav-btn {
            padding: 15px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            border: none;
            border-right: 1px solid black;
            background: white;
        }

        .nav-btn:last-child {
            border-right: none;
        }

        .nav-btn.active {
            background: black;
            color: white;
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        th, td {
            border: 1px dashed black;
            padding: 10px;
            text-align: center;
        }

        .scanned {
            background: green;
            color: white;
        }

        td.clickable {
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            padding: 15px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid black;
            background: white;
            width: 100%;
        }

        .btn.active {
            background: black;
            color: white;
        }

        /* Collapsible sections */
        .section {
            margin-bottom: 10px;
            border: 1px dashed black;
        }

        .section-header {
            padding: 15px;
            font-weight: bold;
            cursor: pointer;
            background: #f0f0f0;
            display: flex;
            justify-content: space-between;
        }

        .section-content {
            padding: 10px;
            display: none;
        }

        .section-content.open {
            display: block;
        }

        /* Grid layouts */
        .compound-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .row-btns {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            max-height: 150px;
            overflow-y: auto;
        }

        .row-btn {
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid black;
            background: white;
        }

        .row-btn.active {
            background: black;
            color: white;
        }

        .lane-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 10px;
            margin-top: 10px;
        }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .numpad button {
            padding: 20px;
            font-size: 20px;
            cursor: pointer;
            border: 1px solid black;
            background: white;
        }

        .letterpad {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
        }

        .letterpad button {
            padding: 12px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid black;
            background: white;
        }

        .display {
            width: 100%;
            padding: 15px;
            font-size: 24px;
            text-align: center;
            border: 1px dashed black;
            margin-bottom: 10px;
            font-family: monospace;
        }

        /* Search */
        .search-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 1px solid black;
            margin-bottom: 10px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px dashed black;
        }

        /* Barcode */
        .barcode-list {
            text-align: center;
        }

        .barcode-item {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px dashed black;
        }

        .sync-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        #pdf-export {
            padding: 20px;
        }

        #pdf-export table {
            width: 100%;
            border-collapse: collapse;
        }

        #pdf-export th, #pdf-export td {
            border: 1px dashed black;
            padding: 10px;
            text-align: center;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
    <h1>VIN Tracker</h1>

    <!-- TRACK VIEW -->
    <div id="trackView" class="view active">
        <table>
            <thead>
                <tr>
                    <th>IN</th>
                    <th>LOCATION</th>
                    <th>OUT</th>
                    <th>LOCATION</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
        <button class="btn" onclick="exportPDF()">Export to PDF</button>
    </div>

    <!-- ADD VIEW -->
    <div id="addView" class="view">
        <!-- VIN Code Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('vinSection')">
                ENTER VIN CODE <span id="vinSectionArrow">+</span>
            </div>
            <div id="vinSection" class="section-content open">
                <div class="display" id="codeDisplay">--------</div>
                <div class="numpad">
                    <button onclick="addDigit('1')">1</button>
                    <button onclick="addDigit('2')">2</button>
                    <button onclick="addDigit('3')">3</button>
                    <button onclick="addDigit('4')">4</button>
                    <button onclick="addDigit('5')">5</button>
                    <button onclick="addDigit('6')">6</button>
                    <button onclick="addDigit('7')">7</button>
                    <button onclick="addDigit('8')">8</button>
                    <button onclick="addDigit('9')">9</button>
                    <button onclick="clearCode()">CLR</button>
                    <button onclick="addDigit('0')">0</button>
                    <button onclick="backspace()">DEL</button>
                </div>
                <div class="letterpad">
                    <button onclick="addDigit('A')">A</button>
                    <button onclick="addDigit('B')">B</button>
                    <button onclick="addDigit('C')">C</button>
                    <button onclick="addDigit('D')">D</button>
                    <button onclick="addDigit('E')">E</button>
                    <button onclick="addDigit('F')">F</button>
                    <button onclick="addDigit('G')">G</button>
                    <button onclick="addDigit('H')">H</button>
                    <button onclick="addDigit('I')">I</button>
                    <button onclick="addDigit('J')">J</button>
                    <button onclick="addDigit('K')">K</button>
                    <button onclick="addDigit('L')">L</button>
                    <button onclick="addDigit('M')">M</button>
                    <button onclick="addDigit('N')">N</button>
                    <button onclick="addDigit('O')">O</button>
                    <button onclick="addDigit('P')">P</button>
                    <button onclick="addDigit('Q')">Q</button>
                    <button onclick="addDigit('R')">R</button>
                    <button onclick="addDigit('S')">S</button>
                    <button onclick="addDigit('T')">T</button>
                    <button onclick="addDigit('U')">U</button>
                    <button onclick="addDigit('V')">V</button>
                    <button onclick="addDigit('W')">W</button>
                    <button onclick="addDigit('X')">X</button>
                    <button onclick="addDigit('Y')">Y</button>
                    <button onclick="addDigit('Z')">Z</button>
                </div>
            </div>
        </div>

        <!-- Compound Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('compoundSection')">
                SELECT COMPOUND <span id="compoundSectionArrow">+</span>
            </div>
            <div id="compoundSection" class="section-content">
                <div class="compound-btns">
                    <button class="btn" onclick="selectCompound('AB')">AB COMPOUND</button>
                    <button class="btn" onclick="selectCompound('VAN')">VAN WORLD</button>
                    <button class="btn" onclick="selectCompound('WAYNE')">WAYNE'S WORLD</button>
                    <button class="btn" onclick="selectCompound('C1')">C1 COMPOUND</button>
                </div>
            </div>
        </div>

        <!-- Row Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('rowSectionContent')">
                SELECT ROW <span id="rowSectionContentArrow">+</span>
            </div>
            <div id="rowSectionContent" class="section-content">
                <div class="row-btns" id="rowBtns"></div>
                <div class="lane-controls">
                    <button class="btn" onclick="laneUp()">UP</button>
                    <button class="btn" onclick="laneDown()">DOWN</button>
                    <button class="btn" onclick="clearLocation()">CLEAR</button>
                </div>
                <!-- Sub-row for C1 -->
                <div id="subRowSection" style="display:none; margin-top:10px;">
                    <div class="compound-btns">
                        <button class="row-btn" onclick="selectSubRow('A')">A - FRONT</button>
                        <button class="row-btn" onclick="selectSubRow('B')">B - BACK</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spot Section -->
        <div class="section">
            <div class="section-header" onclick="toggleSection('spotSection')">
                ENTER SPOT <span id="spotSectionArrow">+</span>
            </div>
            <div id="spotSection" class="section-content">
                <div class="display" id="spotDisplay">---</div>
                <div class="numpad">
                    <button onclick="addSpotDigit('1')">1</button>
                    <button onclick="addSpotDigit('2')">2</button>
                    <button onclick="addSpotDigit('3')">3</button>
                    <button onclick="addSpotDigit('4')">4</button>
                    <button onclick="addSpotDigit('5')">5</button>
                    <button onclick="addSpotDigit('6')">6</button>
                    <button onclick="addSpotDigit('7')">7</button>
                    <button onclick="addSpotDigit('8')">8</button>
                    <button onclick="addSpotDigit('9')">9</button>
                    <button onclick="clearSpot()">CLR</button>
                    <button onclick="addSpotDigit('0')">0</button>
                    <button onclick="backspaceSpot()">DEL</button>
                </div>
            </div>
        </div>

        <!-- Location Preview & Add -->
        <div class="display" id="locationPreview">-</div>
        <button class="btn" onclick="addEntry()">ADD ENTRY</button>
    </div>

    <!-- HISTORY VIEW -->
    <div id="historyView" class="view">
        <div class="sync-btns">
            <button class="btn" onclick="syncToGitHub()">SYNC TO GITHUB</button>
            <button class="btn" onclick="loadFromGitHub()">LOAD FROM GITHUB</button>
        </div>
        <input type="text" class="search-input" id="searchInput" placeholder="Search VIN..." oninput="searchHistory()">
        <div class="history-list" id="historyList"></div>
    </div>

    <!-- BARCODE VIEW -->
    <div id="barcodeView" class="view">
        <h3>Select VIN to generate barcode</h3>
        <div class="barcode-list" id="barcodeList"></div>
    </div>

    <!-- NAVIGATION -->
    <nav class="nav">
        <button class="nav-btn active" onclick="showView('track')">TRACK</button>
        <button class="nav-btn" onclick="showView('add')">ADD</button>
        <button class="nav-btn" onclick="showView('history')">HISTORY</button>
        <button class="nav-btn" onclick="showView('barcode')">BARCODE</button>
    </nav>

    <script>
        // State
        let code = '';
        let spot = '';
        let selectedCompound = '';
        let selectedRow = '';
        let selectedSubRow = '';
        let entries = [];
        let allHistory = [];

        // Load from localStorage on start
        function loadLocalData() {
            const saved = localStorage.getItem('vinTrackerEntries');
            if (saved) {
                entries = JSON.parse(saved);
                renderTable();
            }
            const savedHistory = localStorage.getItem('vinTrackerHistory');
            if (savedHistory) {
                allHistory = JSON.parse(savedHistory);
            }
        }

        // Save to localStorage
        function saveLocalData() {
            localStorage.setItem('vinTrackerEntries', JSON.stringify(entries));
            localStorage.setItem('vinTrackerHistory', JSON.stringify(allHistory));
        }

        // Compound configurations
        const compounds = {
            'AB': { rows: [], prefix: 'AB', spotMax: 300 },
            'VAN': { rows: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''), prefix: 'AB', spotMax: 120 },
            'WAYNE': { rows: [], prefix: '', spotMax: 120 },
            'C1': { rows: [], prefix: 'C1', spotMax: 120, hasSubRow: true }
        };

        // Generate rows
        for (let i = 101; i <= 134; i++) compounds['AB'].rows.push(i.toString());
        for (let i = 101; i <= 130; i++) compounds['WAYNE'].rows.push(i.toString());
        for (let i = 201; i <= 219; i++) compounds['C1'].rows.push(i.toString());

        // Navigation
        function showView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(view + 'View').classList.add('active');
            event.target.classList.add('active');

            if (view === 'history') renderHistory();
            if (view === 'barcode') renderBarcodes();
        }

        // Toggle sections
        function toggleSection(id) {
            const section = document.getElementById(id);
            const arrow = document.getElementById(id + 'Arrow');
            section.classList.toggle('open');
            arrow.textContent = section.classList.contains('open') ? '-' : '+';
        }

        // VIN Code functions
        function addDigit(d) {
            if (code.length < 8) {
                code += d;
                updateCodeDisplay();
            }
        }

        function clearCode() {
            code = '';
            updateCodeDisplay();
        }

        function backspace() {
            code = code.slice(0, -1);
            updateCodeDisplay();
        }

        function updateCodeDisplay() {
            document.getElementById('codeDisplay').textContent = code.padEnd(8, '-');
        }

        // Spot functions
        function addSpotDigit(d) {
            if (spot.length < 3) {
                spot += d;
                updateSpotDisplay();
                updateLocationPreview();
            }
        }

        function clearSpot() {
            spot = '';
            updateSpotDisplay();
            updateLocationPreview();
        }

        function backspaceSpot() {
            spot = spot.slice(0, -1);
            updateSpotDisplay();
            updateLocationPreview();
        }

        function updateSpotDisplay() {
            document.getElementById('spotDisplay').textContent = spot ? spot.padStart(3, '0') : '---';
        }

        // Compound selection
        function selectCompound(comp) {
            selectedCompound = comp;
            selectedRow = '';
            selectedSubRow = '';

            document.querySelectorAll('#compoundSection .btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(comp === 'VAN' ? 'VAN' : comp === 'WAYNE' ? 'WAYNE' : comp));
            });

            document.getElementById('subRowSection').style.display = compounds[comp].hasSubRow ? 'block' : 'none';
            renderRowButtons(comp);
            updateLocationPreview();
        }

        function renderRowButtons(comp) {
            const container = document.getElementById('rowBtns');
            container.innerHTML = '';
            compounds[comp].rows.forEach(row => {
                const btn = document.createElement('button');
                btn.className = 'row-btn';
                btn.textContent = row;
                btn.onclick = () => selectRow(row);
                container.appendChild(btn);
            });
        }

        function selectRow(row) {
            selectedRow = row;
            document.querySelectorAll('#rowBtns .row-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === row);
            });
            updateLocationPreview();
        }

        function selectSubRow(subRow) {
            selectedSubRow = subRow;
            document.querySelectorAll('#subRowSection .row-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.startsWith(subRow));
            });
            updateLocationPreview();
        }

        function laneUp() {
            if (!selectedCompound || !selectedRow) return;
            const rows = compounds[selectedCompound].rows;
            const idx = rows.indexOf(selectedRow);
            if (idx > 0) selectRow(rows[idx - 1]);
        }

        function laneDown() {
            if (!selectedCompound || !selectedRow) return;
            const rows = compounds[selectedCompound].rows;
            const idx = rows.indexOf(selectedRow);
            if (idx < rows.length - 1) selectRow(rows[idx + 1]);
        }

        function clearLocation() {
            selectedCompound = '';
            selectedRow = '';
            selectedSubRow = '';
            document.querySelectorAll('#compoundSection .btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#rowBtns .row-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#subRowSection .row-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('rowBtns').innerHTML = '';
            document.getElementById('subRowSection').style.display = 'none';
            updateLocationPreview();
        }

        function updateLocationPreview() {
            let location = '-';
            const spotStr = spot ? spot.padStart(3, '0') : '___';

            if (selectedCompound && selectedRow) {
                if (selectedCompound === 'AB') {
                    location = 'AB.' + selectedRow + '.' + spotStr;
                } else if (selectedCompound === 'VAN') {
                    location = 'AB.' + selectedRow + '.' + spotStr;
                } else if (selectedCompound === 'WAYNE') {
                    location = selectedRow + '.' + spotStr;
                } else if (selectedCompound === 'C1') {
                    location = 'C1.' + selectedRow + '.' + (selectedSubRow || '?') + '.' + spotStr;
                }
            }

            document.getElementById('locationPreview').textContent = location;
        }

        // Add entry
        function addEntry() {
            if (code.length !== 8) {
                alert('Please enter 8-digit code');
                return;
            }
            if (!selectedCompound || !selectedRow || !spot) {
                alert('Please select compound, row and spot');
                return;
            }
            if (selectedCompound === 'C1' && !selectedSubRow) {
                alert('Please select front (A) or back (B)');
                return;
            }

            const location = document.getElementById('locationPreview').textContent;
            const entry = {
                code: code,
                inLocation: location,
                outCode: '',
                outLocation: '',
                timestamp: new Date().toISOString(),
                inScanned: false,
                outScanned: false
            };

            entries.push(entry);
            allHistory.push({ ...entry });
            saveLocalData();
            renderTable();

            // Reset code and spot only
            code = '';
            spot = '';
            updateCodeDisplay();
            updateSpotDisplay();
            updateLocationPreview();
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            entries.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="clickable ${entry.inScanned ? 'scanned' : ''}" onclick="toggleScan(${index}, 'in')">${entry.code}</td>
                    <td class="clickable ${entry.inScanned ? 'scanned' : ''}" onclick="toggleScan(${index}, 'in')">${entry.inLocation}</td>
                    <td class="clickable ${entry.outScanned ? 'scanned' : ''}" onclick="toggleScan(${index}, 'out')">${entry.outCode}</td>
                    <td class="clickable ${entry.outScanned ? 'scanned' : ''}" onclick="toggleScan(${index}, 'out')">${entry.outLocation}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function toggleScan(index, type) {
            if (type === 'in') {
                entries[index].inScanned = !entries[index].inScanned;
            } else {
                entries[index].outScanned = !entries[index].outScanned;
            }
            saveLocalData();
            renderTable();
        }

        // History
        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            allHistory.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<strong>${entry.code}</strong> - ${entry.inLocation} (${new Date(entry.timestamp).toLocaleDateString()})`;
                list.appendChild(item);
            });
        }

        function searchHistory() {
            const query = document.getElementById('searchInput').value.toUpperCase();
            const list = document.getElementById('historyList');
            list.innerHTML = '';

            allHistory.filter(e => e.code.includes(query) || e.inLocation.includes(query)).forEach(entry => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<strong>${entry.code}</strong> - ${entry.inLocation} (${new Date(entry.timestamp).toLocaleDateString()})`;
                list.appendChild(item);
            });
        }

        // Barcodes
        function renderBarcodes() {
            const list = document.getElementById('barcodeList');
            list.innerHTML = '';

            entries.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'barcode-item';
                item.innerHTML = `
                    <p><strong>${entry.code}</strong></p>
                    <svg id="barcode-${index}"></svg>
                `;
                list.appendChild(item);

                try {
                    JsBarcode(`#barcode-${index}`, entry.code, {
                        format: 'CODE128',
                        width: 2,
                        height: 50,
                        displayValue: true
                    });
                } catch (e) {
                    console.error('Barcode error:', e);
                }
            });
        }

        // GitHub sync
        async function syncToGitHub() {
            const data = {
                entries: entries,
                history: allHistory,
                lastSync: new Date().toISOString()
            };

            try {
                // Create or update data.json in repo
                const content = btoa(JSON.stringify(data, null, 2));

                // Check if file exists
                let sha = '';
                try {
                    const existing = await fetch('https://api.github.com/repos/boybusiness11/vin-tracker/contents/data.json');
                    if (existing.ok) {
                        const json = await existing.json();
                        sha = json.sha;
                    }
                } catch (e) {}

                const body = {
                    message: 'Sync VIN data ' + new Date().toISOString(),
                    content: content
                };
                if (sha) body.sha = sha;

                alert('To sync, run this in terminal:\ngh api repos/boybusiness11/vin-tracker/contents/data.json -X PUT -f message="Sync" -f content="' + content + '"' + (sha ? ' -f sha="' + sha + '"' : ''));
            } catch (e) {
                alert('Sync error: ' + e.message);
            }
        }

        async function loadFromGitHub() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/boybusiness11/vin-tracker/main/data.json?' + Date.now());
                if (response.ok) {
                    const data = await response.json();
                    entries = data.entries || [];
                    allHistory = data.history || [];
                    saveLocalData();
                    renderTable();
                    alert('Data loaded from GitHub!');
                } else {
                    alert('No data.json found in GitHub repo');
                }
            } catch (e) {
                alert('Load error: ' + e.message);
            }
        }

        // Export PDF
        function exportPDF() {
            const table = document.querySelector('#trackView table');
            const pdfContent = document.createElement('div');
            pdfContent.id = 'pdf-export';

            const now = new Date();
            const dateStr = String(now.getDate()).padStart(2, '0') + '/' +
                           String(now.getMonth() + 1).padStart(2, '0') + '/' +
                           now.getFullYear();

            const title = document.createElement('h2');
            title.textContent = 'PDI ' + dateStr;
            title.style.textAlign = 'center';
            title.style.marginBottom = '20px';
            pdfContent.appendChild(title);

            const tableClone = table.cloneNode(true);
            tableClone.querySelectorAll('.scanned').forEach(cell => cell.classList.remove('scanned'));
            pdfContent.appendChild(tableClone);

            document.body.appendChild(pdfContent);

            html2pdf().set({
                margin: 10,
                filename: 'vin-tracker-' + now.toISOString().split('T')[0] + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            }).from(pdfContent).save().then(() => {
                document.body.removeChild(pdfContent);
            });
        }

        // Initialize
        loadLocalData();
    </script>
</body>
</html>
