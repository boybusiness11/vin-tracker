<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIN Tracker</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            padding-bottom: 80px;
            margin: 0;
            touch-action: manipulation;
        }

        /* Prevent zoom on double tap */
        button, input {
            touch-action: manipulation;
        }

        h1, h3 {
            text-align: center;
            margin: 10px 0;
        }

        /* Navigation */
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            background: white;
            border-top: 2px solid black;
        }

        .nav-btn {
            padding: 15px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            border: none;
            border-right: 1px solid black;
            background: white;
        }

        .nav-btn:last-child {
            border-right: none;
        }

        .nav-btn.active {
            background: black;
            color: white;
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        th, td {
            border: 1px dashed black;
            padding: 10px;
            text-align: center;
        }

        .scanned {
            background: green;
            color: white;
        }

        td.clickable {
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            padding: 15px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid black;
            background: white;
            width: 100%;
        }

        .btn.active {
            background: black;
            color: white;
        }

        /* Quick ADD layout */
        .quick-pad {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 3px;
            margin-bottom: 10px;
        }

        .quick-pad button {
            padding: 12px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid black;
            background: white;
        }

        .compound-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .comp-btn {
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid black;
            background: white;
        }

        .comp-btn.active {
            background: black;
            color: white;
        }

        .row-control {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 5px;
            margin-bottom: 10px;
        }

        .ctrl-btn {
            padding: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid black;
            background: white;
        }

        .row-display {
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            border: 1px dashed black;
            font-family: monospace;
        }

        .subrow-control {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-bottom: 10px;
        }

        .sub-btn {
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid black;
            background: white;
        }

        .sub-btn.active {
            background: black;
            color: white;
        }

        .spot-control {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .spot-display {
            padding: 15px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            border: 1px dashed black;
            font-family: monospace;
        }

        .spot-pad {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 3px;
        }

        .spot-pad button {
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid black;
            background: white;
        }

        .location-bar {
            padding: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            border: 1px dashed black;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .add-btn {
            width: 100%;
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid black;
            background: white;
        }

        .display {
            width: 100%;
            padding: 15px;
            font-size: 24px;
            text-align: center;
            border: 1px dashed black;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .vin-input {
            width: 100%;
            padding: 15px;
            font-size: 24px;
            text-align: center;
            border: 1px dashed black;
            margin-bottom: 10px;
            font-family: monospace;
            text-transform: uppercase;
        }

        /* Search */
        .search-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 1px solid black;
            margin-bottom: 10px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px dashed black;
        }

        /* Barcode */
        .barcode-list {
            text-align: center;
        }

        .barcode-item {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px dashed black;
        }

        .sync-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        #pdf-export {
            padding: 20px;
        }

        #pdf-export table {
            width: 100%;
            border-collapse: collapse;
        }

        #pdf-export th, #pdf-export td {
            border: 1px dashed black;
            padding: 10px;
            text-align: center;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
    <h1>VIN Tracker</h1>

    <!-- TRACK VIEW -->
    <div id="trackView" class="view active">
        <table>
            <thead>
                <tr>
                    <th>IN</th>
                    <th>LOCATION</th>
                    <th>OUT</th>
                    <th>LOCATION</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
        <button class="btn" onclick="exportPDF()">Export to PDF</button>
    </div>

    <!-- ADD VIEW -->
    <div id="addView" class="view">
        <!-- VIN Input -->
        <input type="text" class="vin-input" id="codeInput" placeholder="TYPE VIN" maxlength="8"
               oninput="handleVinInput(this)" autocomplete="off" autocapitalize="characters">

        <!-- Clear button -->
        <button class="btn" onclick="clearCode()" style="margin-bottom:10px;">CLEAR</button>

        <!-- Compound buttons -->
        <div class="compound-row">
            <button class="comp-btn" onclick="selectCompound('AB')">AB</button>
            <button class="comp-btn" onclick="selectCompound('VAN')">VAN</button>
            <button class="comp-btn" onclick="selectCompound('WAYNE')">WW</button>
            <button class="comp-btn" onclick="selectCompound('C1')">C1</button>
        </div>
        <div class="compound-row" style="grid-template-columns: repeat(3, 1fr); margin-bottom:10px;">
            <button class="comp-btn" onclick="selectCompound('WSB')">WS.B</button>
            <button class="comp-btn" onclick="selectCompound('WSC')">WS.C</button>
            <button class="comp-btn" onclick="selectCompound('EV')">EV</button>
        </div>

        <!-- Row display with UP/DOWN -->
        <div class="row-control">
            <button class="ctrl-btn" onclick="laneDown()">-</button>
            <div class="row-display" id="rowDisplay">---</div>
            <button class="ctrl-btn" onclick="laneUp()">+</button>
        </div>

        <!-- C1 Front/Back -->
        <div class="subrow-control" id="subRowSection" style="display:none;">
            <button class="sub-btn" onclick="selectSubRow('A')">FRONT</button>
            <button class="sub-btn" onclick="selectSubRow('B')">BACK</button>
        </div>

        <!-- Position/Spot Input -->
        <input type="text" class="vin-input" id="spotInput" placeholder="POSITION" maxlength="3"
               oninput="handleSpotInput(this)" autocomplete="off" inputmode="numeric">

        <!-- Location Preview & Add -->
        <div class="location-bar" id="locationPreview">-</div>
        <button class="add-btn" onclick="addEntry()">ADD</button>
    </div>

    <!-- HISTORY VIEW -->
    <div id="historyView" class="view">
        <div class="sync-btns">
            <button class="btn" onclick="syncToGitHub()">SYNC TO GITHUB</button>
            <button class="btn" onclick="loadFromGitHub()">LOAD FROM GITHUB</button>
        </div>
        <input type="text" class="search-input" id="searchInput" placeholder="Search VIN..." oninput="searchHistory()">
        <div class="history-list" id="historyList"></div>
    </div>

    <!-- BARCODE VIEW -->
    <div id="barcodeView" class="view">
        <h3>Unscanned VINs</h3>
        <div class="barcode-list" id="barcodeList"></div>
    </div>

    <!-- NAVIGATION -->
    <nav class="nav">
        <button class="nav-btn active" onclick="showView('track')">TRACK</button>
        <button class="nav-btn" onclick="showView('add')">ADD</button>
        <button class="nav-btn" onclick="showView('history')">HISTORY</button>
        <button class="nav-btn" onclick="showView('barcode')">BARCODE</button>
    </nav>

    <script>
        // State
        let code = '';
        let spot = '';
        let selectedCompound = '';
        let selectedRow = '';
        let selectedSubRow = '';
        let entries = [];
        let allHistory = [];

        // Load from localStorage on start
        function loadLocalData() {
            const saved = localStorage.getItem('vinTrackerEntries');
            if (saved) {
                entries = JSON.parse(saved);
                renderTable();
            }
            const savedHistory = localStorage.getItem('vinTrackerHistory');
            if (savedHistory) {
                allHistory = JSON.parse(savedHistory);
            }
        }

        // Save to localStorage
        function saveLocalData() {
            localStorage.setItem('vinTrackerEntries', JSON.stringify(entries));
            localStorage.setItem('vinTrackerHistory', JSON.stringify(allHistory));
        }

        // Compound configurations
        const compounds = {
            'AB': { rows: [], prefix: 'AB', spotMax: 300 },
            'VAN': { rows: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''), prefix: 'AB', spotMax: 120 },
            'WAYNE': { rows: [], prefix: '', spotMax: 120 },
            'C1': { rows: [], prefix: 'C1', spotMax: 120, hasSubRow: true },
            'WSB': { rows: ['B'], prefix: 'WS', spotMax: 0, noSpot: true },
            'WSC': { rows: ['C'], prefix: 'WS', spotMax: 10 },
            'EV': { rows: ['EV'], prefix: '', spotMax: 30 }
        };

        // Generate rows
        for (let i = 101; i <= 134; i++) compounds['AB'].rows.push(i.toString());
        for (let i = 101; i <= 130; i++) compounds['WAYNE'].rows.push(i.toString());
        for (let i = 201; i <= 219; i++) compounds['C1'].rows.push(i.toString());

        // Navigation
        function showView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(view + 'View').classList.add('active');
            event.target.classList.add('active');

            if (view === 'history') renderHistory();
            if (view === 'barcode') renderBarcodes();
        }

        // Toggle sections
        function toggleSection(id) {
            const section = document.getElementById(id);
            const arrow = document.getElementById(id + 'Arrow');
            section.classList.toggle('open');
            arrow.textContent = section.classList.contains('open') ? '-' : '+';
        }

        // VIN Code functions
        function handleVinInput(input) {
            code = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 8);
            input.value = code;
        }

        function addDigit(d) {
            if (code.length < 8) {
                code += d;
                updateCodeDisplay();
            }
        }

        function clearCode() {
            code = '';
            updateCodeDisplay();
        }

        function backspace() {
            code = code.slice(0, -1);
            updateCodeDisplay();
        }

        function updateCodeDisplay() {
            document.getElementById('codeInput').value = code;
        }

        // Spot functions
        function handleSpotInput(input) {
            spot = input.value.replace(/[^0-9]/g, '').slice(0, 3);
            input.value = spot;
            updateLocationPreview();
        }

        function clearSpot() {
            spot = '';
            updateSpotDisplay();
            updateLocationPreview();
        }

        function updateSpotDisplay() {
            document.getElementById('spotInput').value = spot;
        }

        // Compound selection
        function selectCompound(comp) {
            selectedCompound = comp;
            selectedSubRow = '';

            // Map button text to compound names
            const btnTextMap = {
                'WW': 'WAYNE',
                'WS.B': 'WSB',
                'WS.C': 'WSC'
            };

            // Update compound buttons
            document.querySelectorAll('.comp-btn').forEach(btn => {
                const btnComp = btnTextMap[btn.textContent] || btn.textContent;
                btn.classList.toggle('active', btnComp === comp);
            });

            // Show/hide front/back for C1
            document.getElementById('subRowSection').style.display = compounds[comp].hasSubRow ? 'grid' : 'none';

            // Show/hide spot input based on noSpot flag
            document.getElementById('spotInput').style.display = compounds[comp].noSpot ? 'none' : 'block';

            // Auto-select first row if none selected
            if (!selectedRow || compounds[comp].rows.indexOf(selectedRow) === -1) {
                selectedRow = compounds[comp].rows[0];
            }
            updateRowDisplay();
            updateLocationPreview();
        }

        function updateRowDisplay() {
            document.getElementById('rowDisplay').textContent = selectedRow || '---';
        }

        function selectRow(row) {
            selectedRow = row;
            updateRowDisplay();
            updateLocationPreview();
        }

        function selectSubRow(subRow) {
            selectedSubRow = subRow;
            document.querySelectorAll('.sub-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === (subRow === 'A' ? 'FRONT' : 'BACK'));
            });
            updateLocationPreview();
        }

        function laneUp() {
            if (!selectedCompound) return;
            const rows = compounds[selectedCompound].rows;
            const idx = rows.indexOf(selectedRow);
            if (idx < rows.length - 1) {
                selectRow(rows[idx + 1]);
            }
        }

        function laneDown() {
            if (!selectedCompound) return;
            const rows = compounds[selectedCompound].rows;
            const idx = rows.indexOf(selectedRow);
            if (idx > 0) {
                selectRow(rows[idx - 1]);
            }
        }

        function clearLocation() {
            selectedCompound = '';
            selectedRow = '';
            selectedSubRow = '';
            document.querySelectorAll('.comp-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.sub-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('rowDisplay').textContent = '---';
            document.getElementById('subRowSection').style.display = 'none';
            updateLocationPreview();
        }

        function updateLocationPreview() {
            let location = '-';
            const spotStr = spot ? spot.padStart(3, '0') : '___';

            if (selectedCompound && selectedRow) {
                if (selectedCompound === 'AB') {
                    location = 'AB.' + selectedRow + '.' + spotStr;
                } else if (selectedCompound === 'VAN') {
                    location = 'AB.' + selectedRow + '.' + spotStr;
                } else if (selectedCompound === 'WAYNE') {
                    location = selectedRow + '.' + spotStr;
                } else if (selectedCompound === 'C1') {
                    location = 'C1.' + selectedRow + '.' + (selectedSubRow || '?') + '.' + spotStr;
                } else if (selectedCompound === 'WSB') {
                    location = 'WS.B';
                } else if (selectedCompound === 'WSC') {
                    location = 'WS.C.' + spotStr;
                } else if (selectedCompound === 'EV') {
                    const evSpot = spot ? spot.padStart(2, '0') : '__';
                    location = 'EV.' + evSpot;
                }
            }

            document.getElementById('locationPreview').textContent = location;
        }

        // Add entry
        function addEntry() {
            if (code.length !== 8) {
                alert('Please enter 8-digit code');
                return;
            }
            const needsSpot = !compounds[selectedCompound]?.noSpot;
            if (!selectedCompound || !selectedRow || (needsSpot && !spot)) {
                alert('Please select compound and location');
                return;
            }
            if (selectedCompound === 'C1' && !selectedSubRow) {
                alert('Please select front (A) or back (B)');
                return;
            }

            const location = document.getElementById('locationPreview').textContent;
            const entry = {
                code: code,
                inLocation: location,
                outCode: '',
                outLocation: '',
                timestamp: new Date().toISOString(),
                inScanned: false,
                outScanned: false
            };

            entries.push(entry);
            allHistory.push({ ...entry });
            saveLocalData();
            renderTable();

            // Reset code and spot only
            code = '';
            spot = '';
            updateCodeDisplay();
            updateSpotDisplay();
            updateLocationPreview();
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            entries.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="clickable ${entry.inScanned ? 'scanned' : ''}" onclick="toggleScan(${index}, 'in')">${entry.code}</td>
                    <td class="clickable ${entry.inScanned ? 'scanned' : ''}" onclick="toggleScan(${index}, 'in')">${entry.inLocation}</td>
                    <td class="clickable ${entry.outScanned ? 'scanned' : ''}" onclick="toggleScan(${index}, 'out')">${entry.outCode}</td>
                    <td class="clickable ${entry.outScanned ? 'scanned' : ''}" onclick="toggleScan(${index}, 'out')">${entry.outLocation}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function toggleScan(index, type) {
            if (type === 'in') {
                entries[index].inScanned = !entries[index].inScanned;
            } else {
                entries[index].outScanned = !entries[index].outScanned;
            }
            saveLocalData();
            renderTable();
        }

        // History
        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            allHistory.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<strong>${entry.code}</strong> - ${entry.inLocation} (${new Date(entry.timestamp).toLocaleDateString()})`;
                list.appendChild(item);
            });
        }

        function searchHistory() {
            const query = document.getElementById('searchInput').value.toUpperCase();
            const list = document.getElementById('historyList');
            list.innerHTML = '';

            allHistory.filter(e => e.code.includes(query) || e.inLocation.includes(query)).forEach(entry => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<strong>${entry.code}</strong> - ${entry.inLocation} (${new Date(entry.timestamp).toLocaleDateString()})`;
                list.appendChild(item);
            });
        }

        // Barcodes - only show unscanned entries
        function renderBarcodes() {
            const list = document.getElementById('barcodeList');
            list.innerHTML = '';

            // Filter to only show entries not yet scanned
            const unscanned = entries.filter(e => !e.inScanned);

            if (unscanned.length === 0) {
                list.innerHTML = '<p>No unscanned VINs</p>';
                return;
            }

            unscanned.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'barcode-item';
                item.innerHTML = `
                    <svg id="barcode-${index}"></svg>
                    <p><strong>VIN:</strong> ${entry.code}</p>
                    <p><strong>LOCATION:</strong> ${entry.inLocation}</p>
                `;
                list.appendChild(item);

                try {
                    JsBarcode(`#barcode-${index}`, entry.code, {
                        format: 'CODE128',
                        width: 2,
                        height: 50,
                        displayValue: false
                    });
                } catch (e) {
                    console.error('Barcode error:', e);
                }
            });
        }

        // GitHub sync
        async function syncToGitHub() {
            const data = {
                entries: entries,
                history: allHistory,
                lastSync: new Date().toISOString()
            };

            try {
                // Create or update data.json in repo
                const content = btoa(JSON.stringify(data, null, 2));

                // Check if file exists
                let sha = '';
                try {
                    const existing = await fetch('https://api.github.com/repos/boybusiness11/vin-tracker/contents/data.json');
                    if (existing.ok) {
                        const json = await existing.json();
                        sha = json.sha;
                    }
                } catch (e) {}

                const body = {
                    message: 'Sync VIN data ' + new Date().toISOString(),
                    content: content
                };
                if (sha) body.sha = sha;

                alert('To sync, run this in terminal:\ngh api repos/boybusiness11/vin-tracker/contents/data.json -X PUT -f message="Sync" -f content="' + content + '"' + (sha ? ' -f sha="' + sha + '"' : ''));
            } catch (e) {
                alert('Sync error: ' + e.message);
            }
        }

        async function loadFromGitHub() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/boybusiness11/vin-tracker/main/data.json?' + Date.now());
                if (response.ok) {
                    const data = await response.json();
                    entries = data.entries || [];
                    allHistory = data.history || [];
                    saveLocalData();
                    renderTable();
                    alert('Data loaded from GitHub!');
                } else {
                    alert('No data.json found in GitHub repo');
                }
            } catch (e) {
                alert('Load error: ' + e.message);
            }
        }

        // Export PDF
        function exportPDF() {
            const table = document.querySelector('#trackView table');
            const pdfContent = document.createElement('div');
            pdfContent.id = 'pdf-export';

            const now = new Date();
            const dateStr = String(now.getDate()).padStart(2, '0') + '/' +
                           String(now.getMonth() + 1).padStart(2, '0') + '/' +
                           now.getFullYear();

            const title = document.createElement('h2');
            title.textContent = 'PDI ' + dateStr;
            title.style.textAlign = 'center';
            title.style.marginBottom = '20px';
            pdfContent.appendChild(title);

            const tableClone = table.cloneNode(true);
            tableClone.querySelectorAll('.scanned').forEach(cell => cell.classList.remove('scanned'));
            pdfContent.appendChild(tableClone);

            document.body.appendChild(pdfContent);

            html2pdf().set({
                margin: 10,
                filename: 'vin-tracker-' + now.toISOString().split('T')[0] + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            }).from(pdfContent).save().then(() => {
                document.body.removeChild(pdfContent);
            });
        }

        // Initialize
        loadLocalData();
    </script>
</body>
</html>
