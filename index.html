<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIN Tracker</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

```
    body {
        font-family: Arial, sans-serif;
        padding: 10px;
        padding-bottom: 80px;
        margin: 0;
        touch-action: manipulation;
    }

    /* Prevent zoom on double tap */
    button, input {
        touch-action: manipulation;
    }

    h1, h3 {
        text-align: center;
        margin: 10px 0;
    }

    /* Navigation */
    .nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        background: white;
        border-top: 2px solid black;
    }

    .nav-btn {
        padding: 15px;
        font-size: 14px;
        font-weight: bold;
        text-align: center;
        cursor: pointer;
        border: none;
        border-right: 1px solid black;
        background: white;
    }

    .nav-btn:last-child {
        border-right: none;
    }

    .nav-btn.active {
        background: black;
        color: white;
    }

    /* Views */
    .view {
        display: none;
    }

    .view.active {
        display: block;
    }

    /* Table */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 15px;
    }

    th, td {
        border: 1px dashed black;
        padding: 10px;
        text-align: center;
    }

    .scanned {
        background: green;
        color: white;
    }

    td.clickable {
        cursor: pointer;
    }

    .delete-btn {
        cursor: pointer;
        color: red;
        font-weight: bold;
        padding: 10px;
    }

    .edit-btn {
        cursor: pointer;
        color: blue;
        font-weight: bold;
        padding: 10px;
    }

    /* Edit Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 5px;
        width: 90%;
        max-width: 400px;
    }

    .modal-content h3 {
        margin-top: 0;
    }

    .modal-content label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }

    .modal-content input {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid black;
        margin-top: 5px;
        text-transform: uppercase;
    }

    .modal-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 15px;
    }

    .modal-buttons button {
        padding: 12px;
        font-size: 16px;
        cursor: pointer;
        border: 1px solid black;
    }

    .swap-btn {
        grid-column: 1 / -1;
        background: #f0f0f0;
    }

    /* Buttons */
    .btn {
        padding: 15px;
        font-size: 16px;
        cursor: pointer;
        border: 1px solid black;
        background: white;
        width: 100%;
    }

    .btn.active {
        background: black;
        color: white;
    }

    /* Quick ADD layout */
    .quick-pad {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 3px;
        margin-bottom: 10px;
    }

    .quick-pad button {
        padding: 12px;
        font-size: 16px;
        cursor: pointer;
        border: 1px solid black;
        background: white;
    }

    .compound-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 5px;
        margin-bottom: 10px;
    }

    .comp-btn {
        padding: 12px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        border: 1px solid black;
        background: white;
    }

    .comp-btn.active {
        background: black;
        color: white;
    }

    .row-control {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        gap: 5px;
        margin-bottom: 10px;
    }

    .ctrl-btn {
        padding: 15px;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        border: 1px solid black;
        background: white;
    }

    .row-display {
        padding: 15px;
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        border: 1px dashed black;
        font-family: monospace;
    }

    .subrow-control {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 5px;
        margin-bottom: 10px;
    }

    .sub-btn {
        padding: 10px;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid black;
        background: white;
    }

    .sub-btn.active {
        background: black;
        color: white;
    }

    .spot-control {
        display: grid;
        grid-template-columns: 1fr 3fr;
        gap: 10px;
        margin-bottom: 10px;
    }

    .spot-display {
        padding: 15px;
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        border: 1px dashed black;
        font-family: monospace;
    }

    .spot-pad {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 3px;
    }

    .spot-pad button {
        padding: 10px;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid black;
        background: white;
    }

    .location-bar {
        padding: 10px;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        border: 1px dashed black;
        margin-bottom: 10px;
        font-family: monospace;
    }

    .add-btn {
        width: 100%;
        padding: 20px;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        border: 2px solid black;
        background: white;
    }

    .display {
        width: 100%;
        padding: 15px;
        font-size: 24px;
        text-align: center;
        border: 1px dashed black;
        margin-bottom: 10px;
        font-family: monospace;
    }

    .vin-input {
        width: 100%;
        padding: 15px;
        font-size: 24px;
        text-align: center;
        border: 1px dashed black;
        margin-bottom: 10px;
        font-family: monospace;
        text-transform: uppercase;
    }

    .inout-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 5px;
        margin-bottom: 10px;
    }

    .inout-btn {
        padding: 15px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        border: 2px solid black;
        background: white;
    }

    .inout-btn.active {
        background: black;
        color: white;
    }

    /* Search */
    .search-input {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        border: 1px solid black;
        margin-bottom: 10px;
    }

    .history-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .history-item {
        padding: 10px;
        border-bottom: 1px dashed black;
    }

    /* Barcode */
    .barcode-list {
        text-align: center;
    }

    .barcode-item {
        margin-bottom: 20px;
        padding: 10px;
        border: 1px dashed black;
    }

    .barcode-counter {
        text-align: center;
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #666;
    }

    .barcode-single {
        text-align: center;
        padding: 20px;
        border: 2px dashed black;
        margin-bottom: 15px;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .barcode-single p {
        margin: 5px 0;
    }

    .barcode-single .vin-code {
        font-size: 28px;
        font-weight: bold;
        font-family: monospace;
        margin: 10px 0;
    }

    .barcode-single .vin-location {
        font-size: 20px;
        color: #333;
    }

    .barcode-single .vin-type {
        font-size: 14px;
        padding: 3px 10px;
        background: #eee;
        border-radius: 3px;
        margin-top: 5px;
    }

    .barcode-nav {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        gap: 10px;
    }

    .barcode-nav-btn {
        padding: 15px;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid black;
        background: white;
    }

    .barcode-scanned-btn {
        padding: 15px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        border: 2px solid green;
        background: green;
        color: white;
    }

    .sync-btns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }

    #pdf-export {
        padding: 20px;
    }

    #pdf-export table {
        width: 100%;
        border-collapse: collapse;
    }

    #pdf-export th, #pdf-export td {
        border: 1px dashed black;
        padding: 10px;
        text-align: center;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
```

</head>
<body>
    <h1>VIN Tracker</h1>

```
<!-- TRACK VIEW -->
<div id="trackView" class="view active">
    <table>
        <thead>
            <tr>
                <th>IN</th>
                <th>LOCATION</th>
                <th>OUT</th>
                <th>LOCATION</th>
            </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
    </table>
    <button class="btn" onclick="exportPDF()">Export to PDF</button>
</div>

<!-- ADD VIEW -->
<div id="addView" class="view">
    <!-- IN/OUT Toggle -->
    <div class="inout-row">
        <button class="inout-btn active" id="inBtn" onclick="selectInOut('IN')">IN</button>
        <button class="inout-btn" id="outBtn" onclick="selectInOut('OUT')">OUT</button>
    </div>

    <!-- VIN Input -->
    <input type="text" class="vin-input" id="codeInput" placeholder="TYPE VIN" maxlength="8"
           oninput="handleVinInput(this)" autocomplete="off" autocapitalize="characters">

    <!-- Clear button -->
    <button class="btn" onclick="clearCode()" style="margin-bottom:10px;">CLEAR</button>

    <!-- Compound buttons -->
    <div class="compound-row">
        <button class="comp-btn" onclick="selectCompound('AB')">AB</button>
        <button class="comp-btn" onclick="selectCompound('VAN')">VAN</button>
        <button class="comp-btn" onclick="selectCompound('WAYNE')">WW</button>
        <button class="comp-btn" onclick="selectCompound('C1')">C1</button>
    </div>
    <div class="compound-row" style="grid-template-columns: repeat(3, 1fr); margin-bottom:10px;">
        <button class="comp-btn" onclick="selectCompound('WSB')">WS.B</button>
        <button class="comp-btn" onclick="selectCompound('WSC')">WS.C</button>
        <button class="comp-btn" onclick="selectCompound('EV')">EV</button>
    </div>

    <!-- Row display with UP/DOWN -->
    <div class="row-control">
        <button class="ctrl-btn" onclick="laneDown()">-</button>
        <div class="row-display" id="rowDisplay">---</div>
        <button class="ctrl-btn" onclick="laneUp()">+</button>
    </div>

    <!-- C1 Front/Back -->
    <div class="subrow-control" id="subRowSection" style="display:none;">
        <button class="sub-btn" onclick="selectSubRow('A')">FRONT</button>
        <button class="sub-btn" onclick="selectSubRow('B')">BACK</button>
    </div>

    <!-- Position/Spot Input -->
    <input type="text" class="vin-input" id="spotInput" placeholder="POSITION" maxlength="3"
           oninput="handleSpotInput(this)" autocomplete="off" inputmode="numeric">

    <!-- Location Preview & Add -->
    <div class="location-bar" id="locationPreview">-</div>
    <button class="add-btn" onclick="addEntry()">ADD</button>
</div>

<!-- HISTORY VIEW -->
<div id="historyView" class="view">
    <div class="sync-btns">
        <button class="btn" onclick="saveToSheets()">SAVE</button>
        <button class="btn" onclick="loadFromSheets()">LOAD</button>
    </div>
    <button class="btn" onclick="exportToOverall()" style="margin-bottom:10px;">EXPORT TO OVERALL</button>
    <input type="text" class="search-input" id="searchInput" placeholder="Search VIN..." oninput="searchHistory()">
    <div class="history-list" id="historyList"></div>
</div>

<!-- BARCODE VIEW -->
<div id="barcodeView" class="view">
    <h3>Unscanned VINs</h3>
    <div class="barcode-counter" id="barcodeCounter">0 of 0</div>
    <div class="barcode-single" id="barcodeSingle">
        <p style="text-align:center;color:#666;">No unscanned VINs</p>
    </div>
    <div class="barcode-nav">
        <button class="barcode-nav-btn" onclick="prevBarcode()">← PREV</button>
        <button class="barcode-scanned-btn" onclick="markScanned()">✓ SCANNED</button>
        <button class="barcode-nav-btn" onclick="nextBarcode()">NEXT →</button>
    </div>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>Edit Entry</h3>
        <label>IN Code:</label>
        <input type="text" id="editInCode" maxlength="8">
        <label>IN Location:</label>
        <input type="text" id="editInLocation">
        <label>OUT Code:</label>
        <input type="text" id="editOutCode" maxlength="8">
        <label>OUT Location:</label>
        <input type="text" id="editOutLocation">
        <div class="modal-buttons">
            <button onclick="closeEditModal()">CANCEL</button>
            <button onclick="saveEdit()" style="background:black;color:white;">SAVE</button>
            <button class="swap-btn" onclick="swapInOut()">⇄ SWAP IN/OUT</button>
        </div>
    </div>
</div>

<!-- NAVIGATION -->
<nav class="nav">
    <button class="nav-btn active" onclick="showView('track')">TRACK</button>
    <button class="nav-btn" onclick="showView('add')">ADD</button>
    <button class="nav-btn" onclick="showView('history')">HISTORY</button>
    <button class="nav-btn" onclick="showView('barcode')">BARCODE</button>
</nav>

<script>
    // State
    let code = '';
    let spot = '';
    let selectedCompound = '';
    let selectedRow = '';
    let selectedSubRow = '';
    let selectedInOut = 'IN';
    let entries = [];
    let allHistory = [];
    let pendingSync = []; // Queue for failed saves
    let isOnline = navigator.onLine;

    // Online/Offline detection
    window.addEventListener('online', () => {
        isOnline = true;
        showStatus('Back online - syncing...');
        syncPendingChanges();
    });

    window.addEventListener('offline', () => {
        isOnline = false;
        showStatus('Offline - changes will sync when connected');
    });

    function showStatus(message) {
        let status = document.getElementById('statusBar');
        if (!status) {
            status = document.createElement('div');
            status.id = 'statusBar';
            status.style.cssText = 'position:fixed;top:0;left:0;right:0;padding:8px;text-align:center;font-size:12px;z-index:999;transition:opacity 0.3s;';
            document.body.prepend(status);
        }
        status.textContent = message;
        status.style.background = isOnline ? '#4CAF50' : '#ff9800';
        status.style.color = 'white';
        status.style.opacity = '1';
        
        // Auto-hide after 3 seconds if online
        if (isOnline) {
            setTimeout(() => {
                status.style.opacity = '0';
            }, 3000);
        }
    }

    // Load pending sync queue from localStorage
    function loadPendingSync() {
        const saved = localStorage.getItem('vinTrackerPending');
        if (saved) {
            pendingSync = JSON.parse(saved);
            if (pendingSync.length > 0) {
                showStatus(pendingSync.length + ' pending changes to sync');
            }
        }
    }

    // Save pending sync queue to localStorage
    function savePendingSync() {
        localStorage.setItem('vinTrackerPending', JSON.stringify(pendingSync));
    }

    // Add to pending queue
    function addToPendingQueue(action, data) {
        pendingSync.push({
            action: action,
            data: data,
            timestamp: new Date().toISOString()
        });
        savePendingSync();
    }

    // Sync all pending changes
    async function syncPendingChanges() {
        if (pendingSync.length === 0) return;
        
        showStatus('Syncing ' + pendingSync.length + ' pending changes...');
        
        // Just sync current entries state - this overwrites with latest
        try {
            const url = SHEETS_URL + '?action=save&data=' + encodeURIComponent(JSON.stringify(entries));
            const response = await fetch(url, { method: 'GET', mode: 'no-cors' });
            
            // Clear pending queue on success
            pendingSync = [];
            savePendingSync();
            showStatus('All changes synced!');
        } catch (e) {
            showStatus('Sync failed - will retry');
        }
    }

    // Load from localStorage on start
    function loadLocalData() {
        const saved = localStorage.getItem('vinTrackerEntries');
        if (saved) {
            entries = JSON.parse(saved);
            renderTable();
        }
        const savedHistory = localStorage.getItem('vinTrackerHistory');
        if (savedHistory) {
            allHistory = JSON.parse(savedHistory);
        }
    }

    // Save to localStorage
    function saveLocalData() {
        localStorage.setItem('vinTrackerEntries', JSON.stringify(entries));
        localStorage.setItem('vinTrackerHistory', JSON.stringify(allHistory));
    }

    // Compound configurations
    const compounds = {
        'AB': { rows: [], prefix: 'AB', spotMax: 300 },
        'VAN': { rows: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''), prefix: 'AB', spotMax: 120 },
        'WAYNE': { rows: [], prefix: '', spotMax: 120 },
        'C1': { rows: [], prefix: 'C1', spotMax: 120, hasSubRow: true },
        'WSB': { rows: ['B'], prefix: 'WS', spotMax: 0, noSpot: true },
        'WSC': { rows: ['C'], prefix: 'WS', spotMax: 10 },
        'EV': { rows: ['EV'], prefix: '', spotMax: 30 }
    };

    // Generate rows
    for (let i = 101; i <= 134; i++) compounds['AB'].rows.push(i.toString());
    for (let i = 101; i <= 130; i++) compounds['WAYNE'].rows.push(i.toString());
    for (let i = 201; i <= 219; i++) compounds['C1'].rows.push(i.toString());

    // Navigation
    function showView(view) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

        document.getElementById(view + 'View').classList.add('active');
        event.target.classList.add('active');

        if (view === 'history') renderHistory();
        if (view === 'barcode') renderBarcodes();
    }

    // Toggle sections
    function toggleSection(id) {
        const section = document.getElementById(id);
        const arrow = document.getElementById(id + 'Arrow');
        section.classList.toggle('open');
        arrow.textContent = section.classList.contains('open') ? '-' : '+';
    }

    // VIN Code functions
    function handleVinInput(input) {
        code = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 8);
        input.value = code;
    }

    function addDigit(d) {
        if (code.length < 8) {
            code += d;
            updateCodeDisplay();
        }
    }

    function clearCode() {
        code = '';
        updateCodeDisplay();
    }

    function backspace() {
        code = code.slice(0, -1);
        updateCodeDisplay();
    }

    function updateCodeDisplay() {
        document.getElementById('codeInput').value = code;
    }

    // Spot functions
    function handleSpotInput(input) {
        spot = input.value.replace(/[^0-9]/g, '').slice(0, 3);
        input.value = spot;
        updateLocationPreview();
    }

    function clearSpot() {
        spot = '';
        updateSpotDisplay();
        updateLocationPreview();
    }

    function updateSpotDisplay() {
        document.getElementById('spotInput').value = spot;
    }

    // IN/OUT selection
    function selectInOut(type) {
        selectedInOut = type;
        document.getElementById('inBtn').classList.toggle('active', type === 'IN');
        document.getElementById('outBtn').classList.toggle('active', type === 'OUT');
    }

    // Compound selection
    function selectCompound(comp) {
        selectedCompound = comp;
        selectedSubRow = '';

        // Map button text to compound names
        const btnTextMap = {
            'WW': 'WAYNE',
            'WS.B': 'WSB',
            'WS.C': 'WSC'
        };

        // Update compound buttons
        document.querySelectorAll('.comp-btn').forEach(btn => {
            const btnComp = btnTextMap[btn.textContent] || btn.textContent;
            btn.classList.toggle('active', btnComp === comp);
        });

        // Show/hide front/back for C1
        document.getElementById('subRowSection').style.display = compounds[comp].hasSubRow ? 'grid' : 'none';

        // Show/hide spot input based on noSpot flag
        document.getElementById('spotInput').style.display = compounds[comp].noSpot ? 'none' : 'block';

        // Auto-select first row if none selected
        if (!selectedRow || compounds[comp].rows.indexOf(selectedRow) === -1) {
            selectedRow = compounds[comp].rows[0];
        }
        updateRowDisplay();
        updateLocationPreview();
    }

    function updateRowDisplay() {
        document.getElementById('rowDisplay').textContent = selectedRow || '---';
    }

    function selectRow(row) {
        selectedRow = row;
        updateRowDisplay();
        updateLocationPreview();
    }

    function selectSubRow(subRow) {
        selectedSubRow = subRow;
        document.querySelectorAll('.sub-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent === (subRow === 'A' ? 'FRONT' : 'BACK'));
        });
        updateLocationPreview();
    }

    function laneUp() {
        if (!selectedCompound) return;
        const rows = compounds[selectedCompound].rows;
        const idx = rows.indexOf(selectedRow);
        if (idx < rows.length - 1) {
            selectRow(rows[idx + 1]);
        }
    }

    function laneDown() {
        if (!selectedCompound) return;
        const rows = compounds[selectedCompound].rows;
        const idx = rows.indexOf(selectedRow);
        if (idx > 0) {
            selectRow(rows[idx - 1]);
        }
    }

    function clearLocation() {
        selectedCompound = '';
        selectedRow = '';
        selectedSubRow = '';
        document.querySelectorAll('.comp-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.sub-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('rowDisplay').textContent = '---';
        document.getElementById('subRowSection').style.display = 'none';
        updateLocationPreview();
    }

    function updateLocationPreview() {
        let location = '-';
        const spotStr = spot ? spot.padStart(3, '0') : '___';

        if (selectedCompound && selectedRow) {
            if (selectedCompound === 'AB') {
                location = 'AB.' + selectedRow + '.' + spotStr;
            } else if (selectedCompound === 'VAN') {
                location = 'AB.' + selectedRow + '.' + spotStr;
            } else if (selectedCompound === 'WAYNE') {
                location = selectedRow + '.' + spotStr;
            } else if (selectedCompound === 'C1') {
                location = 'C1.' + selectedRow + '.' + (selectedSubRow || '?') + '.' + spotStr;
            } else if (selectedCompound === 'WSB') {
                location = 'WS.B';
            } else if (selectedCompound === 'WSC') {
                location = 'WS.C.' + spotStr;
            } else if (selectedCompound === 'EV') {
                const evSpot = spot ? spot.padStart(2, '0') : '__';
                location = 'EV.' + evSpot;
            }
        }

        document.getElementById('locationPreview').textContent = location;
    }

    // Add entry
    function addEntry() {
        if (code.length !== 8) {
            alert('Please enter 8-digit code');
            return;
        }
        const needsSpot = !compounds[selectedCompound]?.noSpot;
        if (!selectedCompound || !selectedRow || (needsSpot && !spot)) {
            alert('Please select compound and location');
            return;
        }
        if (selectedCompound === 'C1' && !selectedSubRow) {
            alert('Please select front (A) or back (B)');
            return;
        }

        const location = document.getElementById('locationPreview').textContent;

        if (selectedInOut === 'IN') {
            // Add new IN entry
            const entry = {
                code: code,
                inLocation: location,
                outCode: '',
                outLocation: '',
                timestamp: new Date().toISOString(),
                inScanned: false,
                outScanned: false
            };
            entries.push(entry);
            allHistory.push({ ...entry });
        } else {
            // Find existing entry and update OUT
            const existingIndex = entries.findIndex(e => e.code === code && !e.outLocation);
            if (existingIndex >= 0) {
                entries[existingIndex].outCode = code;
                entries[existingIndex].outLocation = location;
            } else {
                // No matching IN entry, create new with OUT only
                const entry = {
                    code: '',
                    inLocation: '',
                    outCode: code,
                    outLocation: location,
                    timestamp: new Date().toISOString(),
                    inScanned: false,
                    outScanned: false
                };
                entries.push(entry);
            }
        }

        saveLocalData();
        renderTable();
        saveToSheets(false); // Auto-save to Google Sheets

        // Reset code and spot only
        code = '';
        spot = '';
        updateCodeDisplay();
        updateSpotDisplay();
        updateLocationPreview();
    }

    // Render table
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        entries.forEach((entry, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="clickable ${entry.inScanned ? 'scanned' : ''}" onclick="toggleScan(${index}, 'in')">${entry.code}</td>
                <td class="clickable ${entry.inScanned ? 'scanned' : ''}" onclick="toggleScan(${index}, 'in')">${entry.inLocation}</td>
                <td class="clickable ${entry.outScanned ? 'scanned' : ''}" onclick="toggleScan(${index}, 'out')">${entry.outCode}</td>
                <td class="clickable ${entry.outScanned ? 'scanned' : ''}" onclick="toggleScan(${index}, 'out')">${entry.outLocation}</td>
                <td class="edit-btn" onclick="editEntry(${index})">✎</td>
                <td class="delete-btn" onclick="deleteEntry(${index})">X</td>
            `;
            tbody.appendChild(row);
        });
    }

    // Edit entry
    let editingIndex = -1;

    function editEntry(index) {
        const entry = entries[index];
        editingIndex = index;
        
        // Show edit modal
        const modal = document.getElementById('editModal');
        modal.style.display = 'flex';
        
        // Populate fields
        document.getElementById('editInCode').value = entry.code || '';
        document.getElementById('editInLocation').value = entry.inLocation || '';
        document.getElementById('editOutCode').value = entry.outCode || '';
        document.getElementById('editOutLocation').value = entry.outLocation || '';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        editingIndex = -1;
    }

    function saveEdit() {
        if (editingIndex < 0) return;
        
        entries[editingIndex].code = document.getElementById('editInCode').value.toUpperCase();
        entries[editingIndex].inLocation = document.getElementById('editInLocation').value.toUpperCase();
        entries[editingIndex].outCode = document.getElementById('editOutCode').value.toUpperCase();
        entries[editingIndex].outLocation = document.getElementById('editOutLocation').value.toUpperCase();
        
        saveLocalData();
        renderTable();
        saveToSheets(false);
        closeEditModal();
    }

    function swapInOut() {
        if (editingIndex < 0) return;
        
        // Swap the values in the form
        const inCode = document.getElementById('editInCode').value;
        const inLoc = document.getElementById('editInLocation').value;
        const outCode = document.getElementById('editOutCode').value;
        const outLoc = document.getElementById('editOutLocation').value;
        
        document.getElementById('editInCode').value = outCode;
        document.getElementById('editInLocation').value = outLoc;
        document.getElementById('editOutCode').value = inCode;
        document.getElementById('editOutLocation').value = inLoc;
    }

    function deleteEntry(index) {
        if (confirm('Delete this entry?')) {
            entries.splice(index, 1);
            saveLocalData();
            renderTable();
            saveToSheets(false);
        }
    }

    function toggleScan(index, type) {
        if (type === 'in') {
            entries[index].inScanned = !entries[index].inScanned;
        } else {
            entries[index].outScanned = !entries[index].outScanned;
        }
        saveLocalData();
        renderTable();
        saveToSheets(false);
    }

    // History
    function renderHistory() {
        const list = document.getElementById('historyList');
        list.innerHTML = '<p style="text-align:center;color:#666;">Type to search sheets...</p>';
    }

    let searchTimeout;
    function searchHistory() {
        const query = document.getElementById('searchInput').value.toUpperCase().trim();
        const list = document.getElementById('historyList');
        
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        if (!query) {
            list.innerHTML = '<p style="text-align:center;color:#666;">Type to search sheets...</p>';
            return;
        }
        
        if (query.length < 2) {
            list.innerHTML = '<p style="text-align:center;color:#666;">Type at least 2 characters...</p>';
            return;
        }
        
        list.innerHTML = '<p style="text-align:center;color:#666;">Searching...</p>';
        
        // Debounce - wait 300ms after typing stops
        searchTimeout = setTimeout(() => {
            searchSheets(query);
        }, 300);
    }

    async function searchSheets(query) {
        const list = document.getElementById('historyList');
        try {
            const response = await fetch(SHEETS_URL + '?action=search&query=' + encodeURIComponent(query));
            if (response.ok) {
                const results = await response.json();
                
                if (results.length === 0) {
                    list.innerHTML = '<p style="text-align:center;color:#666;">No results found</p>';
                    return;
                }
                
                list.innerHTML = '';
                results.forEach(entry => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    
                    let html = '';
                    if (entry.code) {
                        html += `<strong>IN:</strong> ${entry.code} → ${entry.inLocation || '-'}<br>`;
                    }
                    if (entry.outCode) {
                        html += `<strong>OUT:</strong> ${entry.outCode} → ${entry.outLocation || '-'}<br>`;
                    }
                    if (entry.timestamp) {
                        html += `<small style="color:#666;">${new Date(entry.timestamp).toLocaleDateString()}</small>`;
                    }
                    
                    item.innerHTML = html;
                    list.appendChild(item);
                });
            } else {
                list.innerHTML = '<p style="text-align:center;color:red;">Search failed</p>';
            }
        } catch (e) {
            console.error('Search error:', e);
            list.innerHTML = '<p style="text-align:center;color:red;">Search error: ' + e.message + '</p>';
        }
    }

    // Barcodes - single view with navigation
    let unscannedItems = [];
    let currentBarcodeIndex = 0;

    function renderBarcodes() {
        // Build list of unscanned items (IN entries not scanned + OUT entries not scanned)
        unscannedItems = [];
        
        entries.forEach((entry, entryIndex) => {
            // Add unscanned IN entries
            if (entry.code && !entry.inScanned) {
                unscannedItems.push({
                    code: entry.code,
                    location: entry.inLocation,
                    type: 'IN',
                    entryIndex: entryIndex,
                    scanType: 'in'
                });
            }
            // Add unscanned OUT entries
            if (entry.outCode && !entry.outScanned) {
                unscannedItems.push({
                    code: entry.outCode,
                    location: entry.outLocation,
                    type: 'OUT',
                    entryIndex: entryIndex,
                    scanType: 'out'
                });
            }
        });

        // Reset index if out of bounds
        if (currentBarcodeIndex >= unscannedItems.length) {
            currentBarcodeIndex = Math.max(0, unscannedItems.length - 1);
        }

        updateBarcodeDisplay();
    }

    function updateBarcodeDisplay() {
        const container = document.getElementById('barcodeSingle');
        const counter = document.getElementById('barcodeCounter');

        if (unscannedItems.length === 0) {
            counter.textContent = '0 of 0';
            container.innerHTML = '<p style="color:#666;">No unscanned VINs</p>';
            return;
        }

        const item = unscannedItems[currentBarcodeIndex];
        counter.textContent = (currentBarcodeIndex + 1) + ' of ' + unscannedItems.length;

        container.innerHTML = `
            <svg id="barcode-current"></svg>
            <p class="vin-code">${item.code}</p>
            <p class="vin-location">${item.location}</p>
            <p class="vin-type">${item.type}</p>
        `;

        try {
            JsBarcode('#barcode-current', item.code, {
                format: 'CODE128',
                width: 2,
                height: 80,
                displayValue: false
            });
        } catch (e) {
            console.error('Barcode error:', e);
        }
    }

    function prevBarcode() {
        if (currentBarcodeIndex > 0) {
            currentBarcodeIndex--;
            updateBarcodeDisplay();
        }
    }

    function nextBarcode() {
        if (currentBarcodeIndex < unscannedItems.length - 1) {
            currentBarcodeIndex++;
            updateBarcodeDisplay();
        }
    }

    function markScanned() {
        if (unscannedItems.length === 0) return;

        const item = unscannedItems[currentBarcodeIndex];
        
        // Mark as scanned in entries
        if (item.scanType === 'in') {
            entries[item.entryIndex].inScanned = true;
        } else {
            entries[item.entryIndex].outScanned = true;
        }

        saveLocalData();
        renderTable();
        saveToSheets(false);

        // Refresh barcode list and show next
        renderBarcodes();
    }

    // Google Sheets sync
    const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbweDFahT4kc8mPWBHuNEECe6qZJHy9ljLYGqP-64g8nWvcpkQZvL738m7r9aAAsSeN5/exec';

    async function saveToSheets(showAlert = true) {
        try {
            const url = SHEETS_URL + '?action=save&data=' + encodeURIComponent(JSON.stringify(entries));
            const response = await fetch(url, { method: 'GET', mode: 'no-cors' });
            if (showAlert) alert('Data saved to Google Sheets!');
        } catch (e) {
            if (showAlert) alert('Save error: ' + e.message);
        }
    }

    async function loadFromSheets(showAlert = true) {
        try {
            const response = await fetch(SHEETS_URL + '?action=load');
            if (response.ok) {
                const data = await response.json();
                entries = data;
                saveLocalData();
                renderTable();
                if (showAlert) alert('Data loaded from Google Sheets!');
            } else {
                if (showAlert) alert('Failed to load from Google Sheets');
            }
        } catch (e) {
            if (showAlert) alert('Load error: ' + e.message);
            // Fall back to local data
            loadLocalData();
        }
    }

    async function exportToOverall() {
        if (entries.length === 0) {
            alert('No entries to export');
            return;
        }
        try {
            const url = SHEETS_URL + '?action=archive&data=' + encodeURIComponent(JSON.stringify(entries));
            await fetch(url, { method: 'GET', mode: 'no-cors' });
            alert('Exported to Overall!');
        } catch (e) {
            alert('Export error: ' + e.message);
        }
    }

    // Export PDF using jsPDF
    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const now = new Date();
        const dateStr = String(now.getDate()).padStart(2, '0') + '/' +
                       String(now.getMonth() + 1).padStart(2, '0') + '/' +
                       now.getFullYear();

        // Title
        doc.setFontSize(18);
        doc.text('PDI ' + dateStr, doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });

        // Table data
        const tableData = entries.map(entry => [
            entry.code || '',
            entry.inLocation || '',
            entry.outCode || '',
            entry.outLocation || ''
        ]);

        // Generate table
        doc.autoTable({
            head: [['IN', 'LOCATION', 'OUT', 'LOCATION']],
            body: tableData,
            startY: 25,
            styles: {
                halign: 'center',
                fontSize: 10
            },
            headStyles: {
                fillColor: [0, 0, 0],
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [245, 245, 245]
            }
        });

        // Download
        doc.save('PDI_' + dateStr.replace(/\//g, '-') + '.pdf');
    }

    // Initialize - auto-load from Google Sheets
    loadFromSheets(false);
</script>
```

</body>
</html>